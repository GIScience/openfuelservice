[tox]
envlist = lint,pytest-{local}-{py38,py39,py310}
# docker excluded until https://github.com/tox-dev/tox-docker/pull/121 is merged.
isolated_build = true
minversion = "3"
basepython = python3.9

[testenv:pytest-{local,docker,github}-{py38,py39,py310}]
basepython =
    py38: python3.8
    py39: python3.9
    py310: python3.10
commands =
    poetry install -v --no-interaction --no-root
    local: bash -c "export DEBUGGING_CONFIG=$PWD/debug.env && python app/tests_pre_start.py && alembic upgrade head && python app/initial_data.py && pytest -x --cov=app --cov-report=term-missing --random-order"
    docker: bash -c "export DEBUGGING_CONFIG=$PWD/debug.env && export CELERY_BROKER_URL=amqp://guest@0.0.0.0:9672// && export POSTGRES_USER=postgres && export POSTGRES_PASSWORD=dontchangeme && export POSTGRES_DB=debug_db && export POSTGRES_PORT=9432 && python app/tests_pre_start.py && python app/backend_pre_start.py && alembic upgrade head && python app/initial_data.py && pytest -x --cov=app --cov-report=term-missing --random-order"
    github: bash -c "export DEBUGGING_CONFIG=$PWD/debug.env && python app/tests_pre_start.py && python app/backend_pre_start.py && alembic upgrade head && python app/initial_data.py && pytest -x --cov=app --cov-report=xml --random-order"
docker =
    docker: pytest_database
    docker: queue
whitelist_externals = poetry
                      bash

[testenv:lint]
commands =
    poetry install --no-interaction --no-root
    mypy app
    black app --check
    isort --recursive --check-only app
    flake8 --jobs=2 app
# Safety Check
    safety check --short-report
    pre-commit run --all-files

whitelist_externals = poetry

[testenv:format]
commands =
    poetry install --extras lint
    isort --recursive  --force-single-line-imports --apply app alembic
    autoflake --remove-all-unused-imports --recursive --remove-unused-variables --in-place app alembic --exclude=__init__.py
    black app alembic
    isort --recursive --apply app alembic
    pre-commit run --all-files

whitelist_externals = poetry

[testenv:init-dev-data]
# Define your .env via DEBUGGING_CONFIG
# export DEBUGGING_CONFIG='debug.env' && export TOX_TESTENV_PASSENV=DEBUGGING_CONFIG && tox -e init-dev-data
isolated_build = true
#skipsdist = False
commands =
    python app/tests_pre_start.py
    python app/backend_pre_start.py
    alembic upgrade head
    python app/initial_data.py

[docker:pytest_database]
image = postgis/postgis:12-3.1-alpine
environment :
    PGDATA=/var/lib/postgresql/data/pgdata
    POSTGRES_USER=postgres
    POSTGRES_PASSWORD=dontchangeme
    POSTGRES_DB=debug_db
    POSTGRES_PORT=5432
ports :
    9432:5432/tcp
# The healthcheck ensures that tox-docker won't run tests until the
# container is up and the command finishes with exit code 0 (success)
healthcheck_cmd = PGPASSWORD=$POSTGRES_PASSWORD psql \
                  --user=$POSTGRES_USER --dbname=$POSTGRES_DB \
                  --host=127.0.0.1 --quiet --no-align --tuples-only \
                  -1 --command="SELECT 1"
healthcheck_timeout = 1
healthcheck_retries = 30
healthcheck_interval = 1
healthcheck_start_period = 1

[docker:queue]
# You can use any value that `docker run` would accept as the image
image = rabbitmq:3
ports :
    9672:5672/tcp
